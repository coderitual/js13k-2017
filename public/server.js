"use strict";function _toConsumableArray$1(e){if(Array.isArray(e)){for(var r=0,a=Array(e.length);e.length>r;r++)a[r]=e[r];return a}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,a=Array(e.length);e.length>r;r++)a[r]=e[r];return a}return Array.from(e)}var loop=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,a=Date.now(),t=setInterval(function(){var r=Date.now();e(r-a),a=r},r);return function(){return clearInterval(t)}},range=function(e){return Array(e).fill()},createPlayer=function(e,r){return{x:e,y:r,vx:0,vy:0,ax:0,ay:0}},projectileId=0,createProjectile=function(e,r,a,t){return{id:projectileId++,x:e,y:r,vx:a,vy:t,created:Date.now(),TTL:3e3}},createTree=function(e,r,a){return{x:e,y:r,r:a}},createHole=function(e,r,a){return{x:e,y:r,r:a}},createWorld=function(e,r){var a={width:e,height:r,trees:new Set,holes:new Set};return range(Math.floor(e/300)).forEach(function(e,t){range(Math.floor(r/300)).forEach(function(e,r){var n=Math.random();if(.3<n){if(n>.3&&.6>n){var o=50*Math.random()+50,c=300-2*o,i=Math.random()*c,u=Math.random()*c;a.holes.add(createHole(i+300*t,u+300*r,o))}}else{var s=50*Math.random()+50,y=300-2*s,l=Math.random()*y,d=Math.random()*y;a.trees.add(createTree(l+300*t,d+300*r,s))}})}),a},createGame=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.maxUsersCount,a=void 0===r?2:r,t=new Set,n=new Set,o=createWorld(2e3,2e3),c=function(e){t.forEach(function(r){var a=r.player,t=r.pointer;if(t){a.ax=t.x,a.ay=t.y;8>Math.abs(a.ax)?a.ax=0:(a.ax>0&&(a.ax-=8),0>a.ax&&(a.ax+=8)),8>Math.abs(a.ay)?a.ay=0:(a.ay>0&&(a.ay-=8),0>a.ay&&(a.ay+=8)),a.vx+=a.ax*e/1e3,a.vy+=a.ay*e/1e3;var n=Math.sqrt(a.vx*a.vx+a.vy*a.vy);if(n>30){var o=n/30;a.vx/=o,a.vy/=o}a.vx*=.98,a.vy*=.98,a.x+=a.vx*e/100,a.y+=a.vy*e/100}}),n.forEach(function(e){var r=Math.sqrt(e.vx*e.vx+e.vy*e.vy);if(r>60){var a=r/60;e.vx/=a,e.vy/=a}}),t.forEach(function(e){var r=e.player;0>r.x?(r.x=0,r.ax*=-1,r.vx*=-1):r.x>o.width&&(r.x=o.width,r.ax*=-1,r.vx*=-1),0>r.y?(r.y=0,r.ay*=-1,r.vy*=-1):r.y>o.height&&(r.y=o.height,r.ay*=-1,r.vy*=-1)})},i=function(){t.forEach(function(e){var r=[].concat(_toConsumableArray$1(t)).filter(function(r){return r!==e}).map(function(e){return{x:e.player.x,y:e.player.y,id:e.socket.id,username:e.username}}),a={x:e.player.x,y:e.player.y,id:e.socket.id,me:!0};e.socket.emit("s:players:update",{me:a,others:r});var o=[].concat(_toConsumableArray$1(n)).map(function(e){return{id:e.id,x:e.x,y:e.y}});e.socket.emit("s:projectiles:update",o)})};loop(function(e){c(e),i()});return{maxUsersCount:a,addUser:function(e){t.add(e),e.player=createPlayer(500,500),e.socket.emit("s:world:create",{width:o.width,height:o.height,holes:[].concat(_toConsumableArray$1(o.holes)),trees:[].concat(_toConsumableArray$1(o.trees))}),e.socket.on("c:pointer:update",function(r){e.pointer=r}),e.socket.on("c:fire:pressed",function(){var r=e.player.x,a=e.player.y,t=e.pointer.x,o=e.pointer.y;n.add(createProjectile(r,a,t,o))})},removeUser:function(e){t.delete(e)},get usersCount(){return t.size},destroy:function(){clearInterval(interval)}}},createUser=function(e,r){return{socket:e,username:r,game:null,player:null,pointer:null}},users=new Set,games=new Set,userId=0,gameId=0,findOrCreateGame=function(){var e=[].concat(_toConsumableArray(games)).find(function(e){return e.maxUsersCount>e.usersCount});return e||(e=createGame({name:"Game "+gameId++}),games.add(e)),e},index=function(e){console.log("connect: "+e.id);var r=e.handshake.query.username,a=void 0===r?"Guest "+userId++:r;console.log(a);var t=createUser(e,a);users.add(t);var n=findOrCreateGame();t.game=n,n.addUser(t),e.on("disconnect",function(){console.log("disconnect: "+e.id),users.delete(t),t.game.removeUser(t)})};module.exports=index;
