"use strict";function _toConsumableArray$1(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);e.length>r;r++)t[r]=e[r];return t}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);e.length>r;r++)t[r]=e[r];return t}return Array.from(e)}var loop=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15,t=Date.now(),a=setInterval(function(){var r=Date.now();e(r-t),t=r},r);return function(){return clearInterval(a)}},range=function(e){return Array(e).fill()},createPlayer=function(){return{x:arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,y:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,vx:0,vy:0,ax:0,ay:0,r:18,kills:0,points:0,deaths:0,position:1,alive:!0,health:5}},projectileId=0,createProjectile=function(e,r,t,a,n){return{id:projectileId++,player:e,x:r,y:t,vx:a,vy:n,r:5,created:Date.now(),TTL:1500}},createTree=function(e,r,t){return{x:e,y:r,r:t}},createHole=function(e,r,t){return{x:e,y:r,r:t}},createWorld=function(e,r){var t={width:e,height:r,trees:new Set,holes:new Set};return range(Math.floor(e/300)).forEach(function(e,a){range(Math.floor(r/300)).forEach(function(e,r){var n=Math.random();if(.3<n){if(n>.3&&.6>n){var o=50*Math.random()+50,i=300-2*o,s=Math.random()*i,c=Math.random()*i;t.holes.add(createHole(s+300*a,c+300*r,o))}}else{var l=50*Math.random()+50,y=300-2*l,u=Math.random()*y,h=Math.random()*y;t.trees.add(createTree(u+300*a,h+300*r,l))}})}),t},createGame=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.maxUsersCount,t=void 0===r?6:r,a=new Set,n=createWorld(2e3,2e3),o=new Set,i=function(e){e.deaths++,e.health=5,e.points=0,s(e)},s=function(e){for(var r=!1;!r;)e.x=Math.random()*n.width,e.y=Math.random()*n.height,r=![].concat(_toConsumableArray$1(n.trees),_toConsumableArray$1(n.holes)).some(function(r){var t=r.x,a=r.y,n=r.r,o=e.x-t,i=e.y-a,s=Math.sqrt(o*o+i*i);return n+e.r>s})},c=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Date.now();a.forEach(function(r){var t=r.player,a=r.pointer;t.ax=a.x,t.ay=a.y;15>Math.abs(t.ax)?t.ax=0:(t.ax>0&&(t.ax-=15),0>t.ax&&(t.ax+=15)),15>Math.abs(t.ay)?t.ay=0:(t.ay>0&&(t.ay-=15),0>t.ay&&(t.ay+=15)),t.vx+=t.ax*e/1e3,t.vy+=t.ay*e/1e3;var n=Math.sqrt(t.vx*t.vx+t.vy*t.vy);if(n>20){var o=n/20;t.vx/=o,t.vy/=o}t.vx*=.98,t.vy*=.98,t.x+=t.vx*e/100,t.y+=t.vy*e/100}),(o=new Set([].concat(_toConsumableArray$1(o)).filter(function(e){return e.TTL>r-e.created}))).forEach(function(r){r.x+=r.vx*e/100,r.y+=r.vy*e/100}),o.forEach(function(e){a.forEach(function(r){var t=r.player;if(e.player!==t){var a=e.x-t.x,n=e.y-t.y,s=Math.sqrt(a*a+n*n);e.r+t.r>s&&(t.health--,o.delete(e),0===t.health&&(i(t),e.player.kills++,e.player.points++))}})}),o.forEach(function(e){n.trees.forEach(function(r){var t=e.x-r.x,a=e.y-r.y,n=Math.sqrt(t*t+a*a);e.r+r.r>n&&o.delete(e)})}),a.forEach(function(r){var t=r.player;n.trees.forEach(function(r){var a=t.x-r.x,n=t.y-r.y,o=Math.sqrt(a*a+n*n);t.r+r.r>o&&(t.x-=t.vx*e/100,t.y-=t.vy*e/100,t.vx*=-1,t.vy*=-1,t.ax*=-1,t.ay*=-1)})}),a.forEach(function(e){var r=e.player;n.holes.forEach(function(e){var t=r.x-e.x,a=r.y-e.y,n=Math.sqrt(t*t+a*a);e.r>n&&i(r)})}),a.forEach(function(e){var r=e.player;0>r.x?(r.x=0,r.ax*=-1,r.vx*=-1):r.x>n.width&&(r.x=n.width,r.ax*=-1,r.vx*=-1),0>r.y?(r.y=0,r.ay*=-1,r.vy*=-1):r.y>n.height&&(r.y=n.height,r.ay*=-1,r.vy*=-1)}),[].concat(_toConsumableArray$1(a)).sort(function(e,r){return r.player.points-e.player.points}).forEach(function(e,r){e.player.position=r+1})},l=function(){a.forEach(function(e){var r=[].concat(_toConsumableArray$1(a)).filter(function(r){return r!==e}).map(function(e){return{x:e.player.x,y:e.player.y,id:e.socket.id,username:e.username,kills:e.player.kills,deaths:e.player.deaths,points:e.player.points,position:e.player.position}}),t={x:e.player.x,y:e.player.y,id:e.socket.id,kills:e.player.kills,deaths:e.player.deaths,points:e.player.points,position:e.player.position,me:!0};e.socket.emit("s:players:update",{me:t,others:r});var n=[].concat(_toConsumableArray$1(o)).map(function(e){return{id:e.id,x:e.x,y:e.y}});e.socket.emit("s:projectiles:update",n)})};return{maxUsersCount:t,destroy:loop(function(e){c(e),l()}),addUser:function(e){a.add(e),e.player=createPlayer(),s(e.player),e.socket.emit("s:world:create",{width:n.width,height:n.height,holes:[].concat(_toConsumableArray$1(n.holes)),trees:[].concat(_toConsumableArray$1(n.trees))}),e.socket.on("c:pointer:update",function(r){e.pointer=r}),e.socket.on("c:fire:pressed",function(){var r=e.player.x,t=e.player.y,a=e.pointer.x,n=e.pointer.y,i=Math.sqrt(a*a+n*n);a/=i,n/=i;a*=60,n*=60,o.add(createProjectile(e.player,r,t,a,n))})},removeUser:function(e){a.delete(e)},get usersCount(){return a.size}}},createUser=function(e,r){return{socket:e,username:r,game:null,player:null,pointer:{x:0,y:0}}},users=new Set,games=new Set,userId=0,gameId=0,findOrCreateGame=function(){var e=[].concat(_toConsumableArray(games)).find(function(e){return e.maxUsersCount>e.usersCount});return e||(e=createGame({name:"Game "+gameId++}),games.add(e)),e},index=function(e){console.log("connect: "+e.id);var r=e.handshake.query.username,t=void 0===r?"Guest "+userId++:r;console.log(t);var a=createUser(e,t);users.add(a);var n=findOrCreateGame();a.game=n,n.addUser(a),e.on("disconnect",function(){console.log("disconnect: "+e.id),users.delete(a);var r=a.game;r.removeUser(a),0===r.usersCount&&(r.destroy(),games.delete(r))})};module.exports=index;
