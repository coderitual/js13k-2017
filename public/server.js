"use strict";function _toConsumableArray$1(e){if(Array.isArray(e)){for(var r=0,n=Array(e.length);e.length>r;r++)n[r]=e[r];return n}return Array.from(e)}function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,n=Array(e.length);e.length>r;r++)n[r]=e[r];return n}return Array.from(e)}var loop=function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:30,n=Date.now(),a=setInterval(function(){var r=Date.now();e(r-n),n=r},r);return function(){return clearInterval(a)}},createPlayer=function(e){return{userId:e,x:0,y:0,vx:0,vy:0,ax:0,ay:0}},createGame=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=e.maxUsersCount,n=void 0===r?2:r,a=new Set,t=function(e){a.forEach(function(r){var n=r.player,a=r.pointer;if(a){n.ax=a.x-a.cw/2,n.ay=a.y-a.ch/2;10>Math.abs(n.ax)?n.ax=0:(n.ax>0&&(n.ax-=10),0>n.ax&&(n.ax+=10)),10>Math.abs(n.ay)?n.ay=0:(n.ay>0&&(n.ay-=10),0>n.ay&&(n.ay+=10)),n.vx+=n.ax*e/1e3,n.vy+=n.ay*e/1e3,n.vx*=.98,n.vy*=.98,n.x+=n.vx*e/100,n.y+=n.vy*e/100}})},o=function(){a.forEach(function(e){var r=[].concat(_toConsumableArray$1(a)).filter(function(r){return r!==e}).map(function(e){return{x:e.player.x,y:e.player.y,id:e.socket.id,username:e.username}}),n={x:e.player.x,y:e.player.y,id:e.socket.id,me:!0};e.socket.emit("s:players:update",{me:n,others:r})})};loop(function(e){t(e),o()});return{maxUsersCount:n,addUser:function(e){a.add(e),e.player=createPlayer(e.socket.id)},removeUser:function(e){a.delete(e)},get usersCount(){return a.size},destroy:function(){clearInterval(interval)}}},createUser=function(e,r){return{socket:e,username:r,game:null,player:null,pointer:null}},users=new Set,games=new Set,userId=0,gameId=0,findOrCreateGame=function(){var e=[].concat(_toConsumableArray(games)).find(function(e){return e.maxUsersCount>e.usersCount});return e||(e=createGame({name:"Game "+gameId++}),games.add(e)),e},index=function(e){console.log("connect: "+e.id);var r=e.handshake.query.username,n=void 0===r?"Guest "+userId++:r;console.log(n);var a=createUser(e,n);users.add(a);var t=findOrCreateGame();a.game=t,t.addUser(a),e.on("disconnect",function(){console.log("disconnect: "+e.id),users.delete(a),a.game.removeUser(a)}),e.on("c:pointer",function(e){a.game&&(a.pointer=e)})};module.exports=index;
